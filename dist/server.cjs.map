{"version":3,"file":"server.cjs","sources":["../src/server/route-wrapper/route-core.ts","../src/server/route-wrapper/index.ts","../src/server/socket-router/config.ts","../src/server/socket-router/core/utils.ts","../src/server/socket-router/core/client.ts","../src/server/socket-router/core/socket-handler.ts","../src/server/socket-router/core/router.ts","../src/server/socket-router/index.ts"],"sourcesContent":["import {\n  CatchHandler,\n  FinisherHandler,\n  RouteHandler,\n  RouteOptions,\n} from './types.type'\n\nexport function routeCore<TParams extends unknown[], TReturn>(\n  options: RouteOptions<TParams, TReturn>\n): ExecuteRoute<TParams, TReturn> {\n  function executeRoute(\n    ...handlers: RouteHandler<TParams>[]\n  ): (...args: TParams) => Promise<unknown> {\n    const totalHandlers = [...(options.middlewares ?? []), ...handlers]\n    return async function (...args: TParams): Promise<unknown> {\n      try {\n        for (const handler of totalHandlers) {\n          let response = handler(...args)\n          while (response instanceof Promise) response = await response\n        }\n        console.warn('No response from handlers')\n      } catch (exception) {\n        let resolvedException = exception\n        while (resolvedException instanceof Promise)\n          resolvedException = await resolvedException\n        if (resolvedException instanceof Error) {\n          if (!options.catcher) throw resolvedException\n          return options.catcher(resolvedException, ...args)\n        }\n        if (!options.finisher) return resolvedException\n        return options.finisher(\n          resolvedException as Exclude<TReturn | void, Error>,\n          ...args\n        )\n      }\n    }\n  }\n\n  function create<\n    TInnerParams extends unknown[] = TParams,\n    TInnerReturn = TReturn,\n  >(\n    catcher?: CatchHandler<TInnerParams>,\n    finisher?: FinisherHandler<TInnerParams, TInnerReturn>\n  ): ExecuteRoute<TInnerParams, TInnerReturn> {\n    return routeCore<TInnerParams, TInnerReturn>({\n      ...(options as unknown as RouteOptions<TInnerParams, TInnerReturn>),\n      catcher:\n        catcher ?? (options.catcher as CatchHandler<TInnerParams> | undefined),\n      finisher:\n        finisher ??\n        (options.finisher as\n          | FinisherHandler<TInnerParams, TInnerReturn>\n          | undefined),\n      middlewares: [\n        ...(options.middlewares ?? []),\n      ] as unknown as RouteHandler<TInnerParams>[],\n    })\n  }\n\n  function use<TH extends RouteHandler<TParams>[] = RouteHandler<TParams>[]>(\n    ...handlers: TH\n  ): ExecuteRoute<TParams, TReturn> {\n    return routeCore<TParams, TReturn>({\n      ...options,\n      middlewares: [...(options.middlewares ?? []), ...handlers],\n    })\n  }\n\n  const exec: ExecuteRoute<TParams, TReturn> = Object.assign(executeRoute, {\n    create,\n    use,\n  })\n\n  return exec\n}\n\nexport type ExecuteRoute<TParams extends unknown[], TReturn> = {\n  (...handlers: RouteHandler<TParams>[]): (...args: TParams) => Promise<unknown>\n  create<TInnerParams extends unknown[] = TParams, TInnerReturn = TReturn>(\n    catcher?: CatchHandler<TInnerParams>,\n    finisher?: FinisherHandler<TInnerParams, TInnerReturn>\n  ): ExecuteRoute<TInnerParams, TInnerReturn>\n  use<THandlers extends RouteHandler<TParams>[] = RouteHandler<TParams>[]>(\n    ...handlers: THandlers\n  ): ExecuteRoute<TParams, TReturn>\n}\n","import { routeCore } from './route-core'\nimport { CatchHandler, FinisherHandler } from './types.type'\nexport * from './types.type'\n\n/**\n * Creates a route wrapper with the given catcher and finisher.\n * @param catcher - The catcher function to handle errors.\n * @param finisher - The finisher function to handle the final result.\n * @returns A route wrapper function.\n * @example\n * ```js\n * const route = routeWrapper<[number, number], number>(\n *   (err) => {\n *     console.log('Error: 1')\n *     return err.message\n *   },\n *   (res) => {\n *     console.log({ res })\n *     return res\n *   }\n * )\n * ```\n */\nexport function routeWrapper<TParams extends unknown[], TReturn = unknown>(\n  catcher?: CatchHandler<TParams>,\n  finisher?: FinisherHandler<TParams, TReturn>\n) {\n  return routeCore<TParams, TReturn>({ catcher: catcher, finisher })\n}\n","import { Client } from './types'\n\nexport const defaultOptions = {\n  handleException(err: unknown, client: Client) {\n    throw { err, client }\n  },\n}\n\nexport const namespaceKey = '___ socket-router.io attached ___'\n","import { Namespace as RawNamespace } from 'socket.io'\nimport { namespaceKey } from '../config'\nimport { Namespace } from '../types'\n\nexport function checkNamespace(namespace: Namespace) {\n  if (!(namespace instanceof RawNamespace)) {\n    throw new Error('First argument must be a namespace')\n  }\n\n  if ((namespace as unknown as Record<string, unknown>)[namespaceKey]) {\n    throw new Error('Another router attached with this namespace')\n  }\n\n  Object.defineProperty(namespace, namespaceKey, {\n    value: true,\n    writable: false,\n    enumerable: false,\n    configurable: false,\n  })\n}\n\nexport function parseEventAndBodyAndSendFn(rawArgs: unknown[]) {\n  const [event, ...args] = rawArgs\n  const lastElement = args[args.length - 1]\n\n  return lastElement instanceof Function\n    ? [event, args.slice(0, -1), lastElement]\n    : [event, args]\n}\n","import { Namespace, Socket } from '../types'\nimport { parseEventAndBodyAndSendFn } from './utils'\n\nexport class Client<TBody extends unknown[]> {\n  body: TBody\n  event: string\n  space: Namespace\n  socket: Socket\n\n  #isDone = false\n  get isDone() {\n    return this.#isDone\n  }\n\n  #sendFn?: (...args: unknown[]) => void\n  get hasSendFn() {\n    return Boolean(this.#sendFn)\n  }\n\n  constructor(space: Namespace, socket: Socket, args: unknown[]) {\n    const [event, body, sendFn] = parseEventAndBodyAndSendFn(args)\n    this.event = event as string\n    this.body = body as TBody\n    this.#sendFn = (typeof sendFn === 'function' ? sendFn : undefined) as\n      | ((...args: unknown[]) => void)\n      | undefined\n    this.space = space\n    this.socket = socket\n  }\n\n  emit(...args: unknown[]) {\n    this.space.emit(this.event, ...args)\n  }\n\n  return(...args: unknown[]) {\n    if (this.#isDone) throw new Error('Can not send data twice!')\n    this.#isDone = true\n    if (this.#sendFn) this.#sendFn(...args)\n  }\n}\n","import { Client, HandlersEntries, HandlersList, Options } from '../types'\n\nexport function socketHandler(\n  entries: HandlersEntries,\n  client: Client,\n  conf: Options\n): void {\n  const next = entries.next()\n  if (next.done) return\n  const [config, handler] = next.value as HandlersList\n\n  if (config.event && config.event !== client.event) {\n    return socketHandler(entries, client, conf)\n  }\n\n  try {\n    const rv = handler(client, (err: unknown) => {\n      if (err == null) socketHandler(entries, client, conf)\n      else conf.handleException(err, client)\n    })\n\n    if (rv instanceof Promise) {\n      rv.catch((err) => conf.handleException(err, client))\n    }\n  } catch (err) {\n    conf.handleException(err, client)\n  }\n}\n","import { defaultOptions } from '../config'\nimport { Controller, HandlersMap, Namespace, OptionsPartial } from '../types'\nimport { Client } from './client'\nimport { socketHandler } from './socket-handler'\nimport { checkNamespace } from './utils'\n\n/**\n * Socket.IO router\n * @class Router\n * @description A Socket.IO router\n * @example\n * const router = new Router()\n * router.on('connect', (socket) => {\n *  console.log('connected')\n * })\n * router.on('message', (socket) => {\n *  console.log('message')\n * })\n * router.on('disconnect', (socket) => {\n *  console.log('disconnected')\n * })\n * router.connect(io, {\n *  handleException: (err, client) => {\n *    console.error(err)\n *  }\n * })\n */\nexport class Router {\n  static create() {\n    return new Router()\n  }\n\n  #store = new Map() as HandlersMap\n\n  #addRouter(path: string, router: Router) {\n    const store = [...router.store]\n    store.forEach(([key, handler]) => {\n      const newEvent = path + key.event\n      this.#store.set({ ...key, event: newEvent }, handler)\n    })\n  }\n\n  #addCallback(path: string, cb: Controller) {\n    this.#store.set({ event: path }, cb)\n  }\n\n  get store() {\n    return this.#store\n  }\n\n  connect(namespace: Namespace, options?: OptionsPartial) {\n    checkNamespace(namespace)\n    const config = options ? { ...defaultOptions, ...options } : defaultOptions\n\n    namespace.on('connect', (socket) => {\n      socket.onAny((...args: unknown[]) => {\n        const entries = this.#store.entries()\n        const client = new Client(namespace, socket, args)\n        socketHandler(entries, client, config)\n      })\n    })\n  }\n\n  on(path: string, ...handlers: (Controller | Router)[]) {\n    handlers.forEach((handler) => {\n      if (handler instanceof Router) {\n        this.#addRouter(path, handler)\n      } else {\n        this.#addCallback(path, handler)\n      }\n    })\n  }\n\n  use(...handlers: (Controller | Router)[]) {\n    this.on('', ...handlers)\n  }\n}\n","import { Router } from './core'\n\nexport * from './types'\nexport { Router as SocketIoRouter }\n\n/**\n * Create a new Socket.IO router\n * @returns {Router} A new Socket.IO router\n */\nexport function createSocketIoRouter() {\n  return new Router()\n}\n"],"names":["RawNamespace"],"mappings":"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"}